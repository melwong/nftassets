
/*!
 * Simple Ajax Uploader
 * Version 2.2.4
 * https://github.com/LPology/Simple-Ajax-Uploader
 *
 * Copyright 2012-2015 LPology, LLC
 * Released under the MIT license
 */
/*!
    Original source: https://github.com/LPology/Simple-Ajax-Uploader

    Modified work:  Implementing image uploading in Coverich Editor
    
    Copyright 2017 Coverich  
    https://www.coverich.com/
 */
(function(global,factory){if(typeof define==="function"&&define.amd){define(function(){return factory(global)})}else{if(typeof module==="object"&&module.exports){module.exports=factory(global)}else{global.ss=factory(global)}}}(typeof window!=="undefined"?window:this,function(window){var ss=window.ss||{},rLWhitespace=/^\s+/,rTWhitespace=/\s+$/,uidReplace=/[xy]/g,rPath=/.*(\/|\\)/,rExt=/.*[.]/,rHasClass=/[\t\r\n]/g,isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,isIE7=(navigator.userAgent.indexOf("MSIE 7")!==-1),input=document.createElement("input"),XhrOk;input.type="file";XhrOk=("multiple" in input&&typeof File!=="undefined"&&typeof(new XMLHttpRequest()).upload!=="undefined");ss.obj2string=function(obj,prefix){var str=[];for(var prop in obj){if(obj.hasOwnProperty(prop)){var k=prefix?prefix+"["+prop+"]":prop,v=obj[prop];str.push(typeof v==="object"?ss.obj2string(v,k):encodeURIComponent(k)+"="+encodeURIComponent(v))}}return str.join("&")};ss.extendObj=function(first,second){for(var prop in second){if(second.hasOwnProperty(prop)){first[prop]=second[prop]}}};ss.addEvent=function(elem,type,fn){if(elem.addEventListener){elem.addEventListener(type,fn,false)}else{elem.attachEvent("on"+type,fn)}return function(){ss.removeEvent(elem,type,fn)}};ss.removeEvent=document.removeEventListener?function(elem,type,fn){if(elem.removeEventListener){elem.removeEventListener(type,fn,false)}}:function(elem,type,fn){var name="on"+type;if(typeof elem[name]==="undefined"){elem[name]=null}elem.detachEvent(name,fn)};ss.newXHR=function(){if(typeof XMLHttpRequest!=="undefined"){return new window.XMLHttpRequest()}else{if(window.ActiveXObject){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(err){return false}}}};ss.getIFrame=function(){var id=ss.getUID(),iframe;if(isIE7){iframe=document.createElement('<iframe src="javascript:false;" name="'+id+'">')}else{iframe=document.createElement("iframe");iframe.src="javascript:false;";iframe.name=id}iframe.style.display="none";iframe.id=id;return iframe};ss.getForm=function(opts){var form=document.createElement("form");form.encoding="multipart/form-data";form.enctype="multipart/form-data";form.style.display="none";for(var prop in opts){if(opts.hasOwnProperty(prop)){form[prop]=opts[prop]}}return form};ss.getHidden=function(name,value){var input=document.createElement("input");input.type="hidden";input.name=name;input.value=value;return input};ss.parseJSON=function(data){if(!data){return false}data=ss.trim(data+"");if(window.JSON&&window.JSON.parse){try{return window.JSON.parse(data+"")}catch(err){return false}}var rvalidtokens=/(,)|(\[|{)|(}|])|"(?:[^"\\\r\n]|\\["\\\/bfnrt]|\\u[\da-fA-F]{4})*"\s*:?|true|false|null|-?(?!0\d)\d+(?:\.\d+|)(?:[eE][+-]?\d+|)/g,depth=null,requireNonComma;return data&&!ss.trim(data.replace(rvalidtokens,function(token,comma,open,close){if(requireNonComma&&comma){depth=0}if(depth===0){return token}requireNonComma=open||comma;depth+=!close-!open;return""}))?(Function("return "+data))():false};ss.getBox=function(elem){var box,docElem,top=0,left=0;if(elem.getBoundingClientRect){box=elem.getBoundingClientRect();docElem=document.documentElement;top=box.top+(window.pageYOffset||docElem.scrollTop)-(docElem.clientTop||0);left=box.left+(window.pageXOffset||docElem.scrollLeft)-(docElem.clientLeft||0)}else{do{left+=elem.offsetLeft;top+=elem.offsetTop}while((elem=elem.offsetParent))}return{top:Math.round(top),left:Math.round(left)}};ss.addStyles=function(elem,styles){for(var name in styles){if(styles.hasOwnProperty(name)){elem.style[name]=styles[name]}}};ss.copyLayout=function(from,to){var box=ss.getBox(from);ss.addStyles(to,{position:"absolute",left:box.left+"px",top:box.top+"px",width:from.offsetWidth+"px",height:from.offsetHeight+"px"})};ss.getUID=function(){return"axxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(uidReplace,function(c){var r=Math.random()*16|0,v=c=="x"?r:(r&3|8);return v.toString(16)})};ss.trim=function(text){return text.toString().replace(rLWhitespace,"").replace(rTWhitespace,"")};ss.getFilename=function(path){return path.replace(rPath,"")};ss.getExt=function(file){return(-1!==file.indexOf("."))?file.replace(rExt,""):""};ss.hasClass=function(elem,name){if(!elem||!name){return false}return(" "+elem.className+" ").replace(rHasClass," ").indexOf(" "+name+" ")>=0};ss.addClass=function(elem,name){if(!elem||!name){return false}if(!ss.hasClass(elem,name)){elem.className+=" "+name}};ss.removeClass=(function(){var c={};return function(e,name){if(!e||!name){return false}if(!c[name]){c[name]=new RegExp("(?:^|\\s)"+name+"(?!\\S)")}e.className=e.className.replace(c[name],"")}})();ss.purge=function(d){var a=d.attributes,i,l,n;if(a){for(i=a.length-1;i>=0;i-=1){n=a[i].name;if(typeof d[n]==="function"){d[n]=null}}}a=d.childNodes;if(a){l=a.length;for(i=0;i<l;i+=1){ss.purge(d.childNodes[i])}}};ss.remove=function(elem){if(elem&&elem.parentNode){ss.purge(elem);elem.parentNode.removeChild(elem)}elem=null};ss.verifyElem=function(elem){if(typeof jQuery!=="undefined"&&elem instanceof jQuery){elem=elem[0]}else{if(typeof elem==="string"){if(elem.charAt(0)=="#"){elem=elem.substr(1)}elem=document.getElementById(elem)}}if(!elem||elem.nodeType!==1){return false}if(elem.nodeName.toUpperCase()=="A"){elem.style.cursor="pointer";ss.addEvent(elem,"click",function(e){if(e&&e.preventDefault){e.preventDefault()}else{if(window.event){window.event.returnValue=false}}})}return elem};ss._options={};ss.uploadSetup=function(options){ss.extendObj(ss._options,options)};ss.SimpleUpload=function(options){var i,len,btn;this._opts={id:0,button:"",url:"",dropzone:"",dragClass:"",cors:false,progressUrl:false,sessionProgressUrl:false,nginxProgressUrl:false,multiple:false,maxUploads:3,queue:true,checkProgressInterval:500,keyParamName:"APC_UPLOAD_PROGRESS",sessionProgressName:"PHP_SESSION_UPLOAD_PROGRESS",nginxProgressHeader:"X-Progress-ID",corsInputName:"XHR_CORS_TARGETORIGIN",allowedExtensions:[],accept:"",maxSize:false,name:"",data:{},noParams:false,autoSubmit:true,multipart:false,method:"POST",responseType:"",debug:false,hoverClass:"",focusClass:"",disabledClass:"",customHeaders:{},encodeCustomHeaders:false,onAbort:function(filename,uploadBtn,size,layer){},onChange:function(filename,extension,uploadBtn,size){},onSubmit:function(filename,extension,uploadBtn,size){},onProgress:function(pct){},onUpdateFileSize:function(filesize){},onComplete:function(filename,response,uploadBtn,size,layer){},onExtError:function(filename,extension){},onSizeError:function(filename,fileSize){},onError:function(filename,type,status,statusText,response,uploadBtn,size,layer){},startXHR:function(filename,fileSize,uploadBtn){},endXHR:function(filename,fileSize,uploadBtn){},startNonXHR:function(filename,uploadBtn){},endNonXHR:function(filename,uploadBtn){}};ss.extendObj(this._opts,ss._options);ss.extendObj(this._opts,options);options=null;this._btns=[];if(this._opts.button instanceof Array){len=this._opts.button.length;for(i=0;i<len;i++){btn=ss.verifyElem(this._opts.button[i]);if(btn!==false){this._btns.push(this.rerouteClicks(btn))}else{this.log("Button with array index "+i+" is invalid")}}}else{btn=ss.verifyElem(this._opts.button);if(btn!==false){this._btns.push(this.rerouteClicks(btn))}}delete this._opts.button;this._opts.button=btn=null;if(this._opts.dropzone===""&&(this._btns.length<1||this._btns[0]===false)){throw new Error("Invalid button. Make sure the element you're passing exists.")}if(this._opts.multiple===false){this._opts.maxUploads=1}this._queue=[];this._active=0;this._disabled=false;this._maxFails=10;this._progKeys={};if(!XhrOk){this._sizeFlags={}}if(XhrOk&&this._opts.dropzone!==""){this._dzone=ss.verifyElem(this._opts.dropzone);if(!this._dzone){this.log("Invalid or nonexistent element passed for drop zone")}else{this.addDropZone(this._dzone)}}this._createInput();this._manDisabled=false;this.enable(true)};ss.SimpleUpload.prototype={_killInput:function(){if(!this._input){return}if(this._input.turnOff){this._input.turnOff()}if(this._input.focusOff){this._input.focusOff()}if(this._input.blurOff){this._input.blurOff()}if(this._input.parentNode.mouseOverOff){this._input.parentNode.mouseOverOff()}ss.remove(this._input.parentNode);delete this._input;this._input=null},destroy:function(){var i=this._btns.length;while(i--){if(this._btns[i].off){this._btns[i].off()}ss.removeClass(this._btns[i],this._opts.hoverClass);ss.removeClass(this._btns[i],this._opts.focusClass);ss.removeClass(this._btns[i],this._opts.disabledClass);this._btns[i].disabled=false}this._killInput();this._destroy=true},log:function(str){if(this._opts&&this._opts.debug&&window.console&&window.console.log){window.console.log("[Uploader] "+str)}},setData:function(data){this._opts.data=data},getID:function(){return this._opts.data.current_layer},setOptions:function(options){ss.extendObj(this._opts,options)},setProgressBar:function(elem){this._progBar=ss.verifyElem(elem)},setPctBox:function(elem){this._pctBox=ss.verifyElem(elem)},setFileSizeBox:function(elem){this._sizeBox=ss.verifyElem(elem)},setProgressContainer:function(elem){this._progBox=ss.verifyElem(elem)},setAbortBtn:function(elem,remove){this._abortBtn=ss.verifyElem(elem);this._removeAbort=false;if(remove){this._removeAbort=true}},getQueueSize:function(){return this._queue.length},_cycleQueue:function(){if(this._queue.length>0&&this._opts.autoSubmit){this.submit()}},removeCurrent:function(id){if(id){var i=this._queue.length;while(i--){if(this._queue[i].id===id){this._queue.splice(i,1);break}}}else{this._queue.splice(0,1)}this._cycleQueue()},clearQueue:function(){this._queue.length=0},disable:function(_self){var i=this._btns.length,nodeName;this._manDisabled=!_self||this._manDisabled===true?true:false;this._disabled=true;while(i--){nodeName=this._btns[i].nodeName.toUpperCase();if(nodeName=="INPUT"||nodeName=="BUTTON"){this._btns[i].disabled=true}if(this._opts.disabledClass!==""){ss.addClass(this._btns[i],this._opts.disabledClass)}}if(this._input&&this._input.parentNode){this._input.parentNode.style.visibility="hidden"}},enable:function(_self){if(!_self){this._manDisabled=false}if(this._manDisabled===true){return}var i=this._btns.length;this._disabled=false;while(i--){ss.removeClass(this._btns[i],this._opts.disabledClass);this._btns[i].disabled=false}},updatePosition:function(){if(this._btns[0]&&this._input&&this._input.parentNode){this._overBtn=this._btns[0];ss.copyLayout(this._btns[0],this._input.parentNode)}}};ss.IframeUpload={_getHost:function(uri){var a=document.createElement("a");a.href=uri;if(a.hostname){return a.hostname.toLowerCase()}return uri},_addFiles:function(file){var filename=ss.getFilename(file.value),ext=ss.getExt(filename);if(false===this._opts.onChange.call(this,filename,ext,this._overBtn)){return false}var layer=0;if(typeof UI!=="undefined"){layer=(UI.upload_to_editor_layer==-1)?WPCoverich.current:UI.upload_to_editor_layer}this._queue.push({id:ss.getUID(),file:file,name:filename,ext:ext,btn:this._overBtn,size:null,layer:layer});return true},_uploadIframe:function(fileObj,progBox,sizeBox,progBar,pctBox,abortBtn,removeAbort){var self=this,opts=this._opts,key=ss.getUID(),iframe=ss.getIFrame(),form,url,msgLoaded=false,iframeLoaded=false,removeMessageListener,removeLoadListener,cancel;if(opts.noParams===true){url=opts.url}else{url=!opts.nginxProgressUrl?opts.url:url+((url.indexOf("?")>-1)?"&":"?")+encodeURIComponent(opts.nginxProgressHeader)+"="+encodeURIComponent(key)}form=ss.getForm({action:url,target:iframe.name,method:opts.method});opts.onProgress.call(this,0);if(pctBox){pctBox.innerHTML="0%"}if(progBar){progBar.style.width="0%"}if(opts.cors){removeMessageListener=ss.addEvent(window,"message",function(event){if(self._getHost(event.origin)!=self._getHost(opts.url)){self.log("Non-matching origin: "+event.origin);return}msgLoaded=true;removeMessageListener();opts.endNonXHR.call(self,fileObj.name,fileObj.btn);self._finish(fileObj,"","",event.data,sizeBox,progBox,pctBox,abortBtn,removeAbort)})}var remove=ss.addEvent(iframe,"load",function(){remove();if(opts.sessionProgressUrl){form.appendChild(ss.getHidden(opts.sessionProgressName,key))}else{if(opts.progressUrl){form.appendChild(ss.getHidden(opts.keyParamName,key))}}for(var prop in opts.data){if(opts.data.hasOwnProperty(prop)){form.appendChild(ss.getHidden(prop,opts.data[prop]))}}if(opts.cors){form.appendChild(ss.getHidden(opts.corsInputName,window.location.href))}form.appendChild(fileObj.file);removeLoadListener=ss.addEvent(iframe,"load",function(){if(!iframe.parentNode||iframeLoaded){return}iframeLoaded=true;delete self._progKeys[key];delete self._sizeFlags[key];removeLoadListener();if(abortBtn){ss.removeEvent(abortBtn,"click",cancel)}if(opts.cors){window.setTimeout(function(){ss.remove(form);ss.remove(iframe);if(!msgLoaded){self._errorFinish(fileObj,"","",false,"error",progBox,sizeBox,pctBox,abortBtn,removeAbort)}opts=key=form=iframe=sizeBox=progBox=pctBox=abortBtn=removeAbort=null},600)}else{try{var doc=iframe.contentDocument?iframe.contentDocument:iframe.contentWindow.document,response=doc.body.innerHTML;opts.endNonXHR.call(self,fileObj.name,fileObj.btn);self._finish(fileObj,"","",response,sizeBox,progBox,pctBox,abortBtn,removeAbort)}catch(e){self._errorFinish(fileObj,"",e.message,false,"error",progBox,sizeBox,pctBox,abortBtn,removeAbort)}window.setTimeout(function(){ss.remove(form);ss.remove(iframe);form=iframe=null},0);fileObj=opts=key=sizeBox=progBox=pctBox=null}});if(abortBtn){cancel=function(){ss.removeEvent(abortBtn,"click",cancel);delete self._progKeys[key];delete self._sizeFlags[key];if(iframe){iframeLoaded=true;removeLoadListener();try{if(iframe.contentWindow.document.execCommand){iframe.contentWindow.document.execCommand("Stop")}}catch(err){}try{iframe.src="javascript".concat(":false;")}catch(err){}window.setTimeout(function(){ss.remove(form);ss.remove(iframe);form=iframe=null},0)}self.log("Upload aborted");opts.onAbort.call(self,fileObj.name,fileObj.btn,fileObj.size,fileObj.layer);self._last(sizeBox,progBox,pctBox,abortBtn,removeAbort)};ss.addEvent(abortBtn,"click",cancel)}self.log("Commencing upload using iframe");form.submit();if(self._hasProgUrl){self._progKeys[key]=1;window.setTimeout(function(){self._getProg(key,progBar,sizeBox,pctBox,1);progBar=sizeBox=pctBox=null},600)}window.setTimeout(function(){self.removeCurrent(fileObj.id)},0)});document.body.appendChild(form);document.body.appendChild(iframe)},_getProg:function(key,progBar,sizeBox,pctBox,counter){var self=this,opts=this._opts,time=new Date().getTime(),xhr,url,callback;if(!key){return}if(opts.nginxProgressUrl){url=opts.nginxProgressUrl+"?"+encodeURIComponent(opts.nginxProgressHeader)+"="+encodeURIComponent(key)+"&_="+time}else{if(opts.sessionProgressUrl){url=opts.sessionProgressUrl}else{if(opts.progressUrl){url=opts.progressUrl+"?progresskey="+encodeURIComponent(key)+"&_="+time}}}callback=function(){var response,size,pct,status,statusText;try{if(callback&&(opts.cors||xhr.readyState===4)){callback=undefined;xhr.onreadystatechange=function(){};try{statusText=xhr.statusText;status=xhr.status}catch(e){statusText="";status=""}if(opts.cors||(status>=200&&status<300)){response=ss.parseJSON(xhr.responseText);if(response===false){self.log("Error parsing progress response (expecting JSON)");return}if(opts.nginxProgressUrl){if(response.state=="uploading"){size=parseInt(response.size,10);if(size>0){pct=Math.round((parseInt(response.received,10)/size)*100);size=Math.round(size/1024)}}else{if(response.state=="done"){pct=100}else{if(response.state=="error"){self.log("Error requesting upload progress: "+response.status);return}}}}else{if(opts.sessionProgressUrl||opts.progressUrl){if(response.success===true){size=parseInt(response.size,10);pct=parseInt(response.pct,10)}}}if(pct){if(pctBox){pctBox.innerHTML=pct+"%"}if(progBar){progBar.style.width=pct+"%"}opts.onProgress.call(self,pct)}if(size&&!self._sizeFlags[key]){if(sizeBox){sizeBox.innerHTML=size+"K"}self._sizeFlags[key]=1;opts.onUpdateFileSize.call(self,size)}if(!pct&&!size&&counter>=self._maxFails){counter++;self.log("Failed progress request limit reached. Count: "+counter);return}if(pct<100&&self._progKeys[key]){window.setTimeout(function(){self._getProg(key,progBar,sizeBox,pctBox,counter);key=progBar=sizeBox=pctBox=counter=null},opts.checkProgressInterval)}}else{delete self._progKeys[key];self.log("Error requesting upload progress: "+status+" "+statusText)}xhr=size=pct=status=statusText=response=null}}catch(e){self.log("Error requesting upload progress: "+e.message)}};if(opts.cors&&!opts.sessionProgressUrl){if(window.XDomainRequest){xhr=new window.XDomainRequest();xhr.open("GET",url,true);xhr.onprogress=xhr.ontimeout=function(){};xhr.onload=callback;xhr.onerror=function(){delete self._progKeys[key];key=null;self.log("Error requesting upload progress")}}else{return}}else{var method=!opts.sessionProgressUrl?"GET":"POST",params;xhr=ss.newXHR();xhr.onreadystatechange=callback;xhr.open(method,url,true);if(opts.sessionProgressUrl){params=encodeURIComponent(opts.sessionProgressName)+"="+encodeURIComponent(key);xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded")}if(opts.nginxProgressUrl){xhr.setRequestHeader(opts.nginxProgressHeader,key)}xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");xhr.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01");xhr.send((opts.sessionProgressUrl&&params)||null)}},_initUpload:function(fileObj){if(false===this._opts.startNonXHR.call(this,fileObj.name,fileObj.btn)){if(this._disabled){this.enable(true)}this._active--;return}this._hasProgUrl=(this._opts.progressUrl||this._opts.sessionProgressUrl||this._opts.nginxProgressUrl)?true:false;this._uploadIframe(fileObj,this._progBox,this._sizeBox,this._progBar,this._pctBox,this._abortBtn,this._removeAbort);this._progBox=this._sizeBox=this._progBar=this._pctBox=this._abortBtn=this._removeAbort=null}};ss.XhrUpload={_addFiles:function(files){var total=files.length,filename,ext,size,i;if(!this._opts.multiple){total=1}for(i=0;i<total;i++){filename=ss.getFilename(files[i].name);ext=ss.getExt(filename);size=Math.round(files[i].size/1024);if(false===this._opts.onChange.call(this,filename,ext,this._overBtn,size)){return false}var layer=0;if(typeof UI!=="undefined"){layer=(UI.upload_to_editor_layer==-1)?WPCoverich.current:UI.upload_to_editor_layer}this._queue.push({id:ss.getUID(),file:files[i],name:filename,ext:ext,btn:this._overBtn,size:size,layer:layer})}return true},_uploadXhr:function(fileObj,url,params,headers,sizeBox,progBar,progBox,pctBox,abortBtn,removeAbort){var self=this,opts=this._opts,xhr=ss.newXHR(),callback,cancel;if(sizeBox){sizeBox.innerHTML=fileObj.size+"K"}if(pctBox){pctBox.innerHTML="0%"}if(progBar){progBar.style.width="0%"}opts.onProgress.call(this,0);callback=function(_,isAbort){var status,statusText;try{if(callback&&(isAbort||xhr.readyState===4)){callback=undefined;xhr.onreadystatechange=function(){};if(isAbort){if(xhr.readyState!==4){xhr.abort()}opts.onAbort.call(self,fileObj.name,fileObj.btn,fileObj.size,fileObj.layer);self._last(sizeBox,progBox,pctBox,abortBtn,removeAbort)}else{if(abortBtn){ss.removeEvent(abortBtn,"click",cancel)}status=xhr.status;try{statusText=xhr.statusText}catch(e){statusText=""}if(status>=200&&status<300){opts.endXHR.call(self,fileObj.name,fileObj.size,fileObj.btn);self._finish(fileObj,status,statusText,xhr.responseText,sizeBox,progBox,pctBox,abortBtn,removeAbort)}else{self._errorFinish(fileObj,status,statusText,xhr.responseText,"error",progBox,sizeBox,pctBox,abortBtn,removeAbort)}}}}catch(e){if(!isAbort){self._errorFinish(fileObj,-1,e.message,false,"error",progBox,sizeBox,pctBox,abortBtn,removeAbort)}}};if(abortBtn){cancel=function(){ss.removeEvent(abortBtn,"click",cancel);if(callback){callback(undefined,true)}};ss.addEvent(abortBtn,"click",cancel)}xhr.onreadystatechange=callback;xhr.open(opts.method.toUpperCase(),url,true);ss.extendObj(headers,opts.customHeaders);for(var i in headers){if(headers.hasOwnProperty(i)){if(opts.encodeCustomHeaders&&opts.customHeaders.hasOwnProperty(i)){xhr.setRequestHeader(i,encodeURIComponent(headers[i])+"")}else{xhr.setRequestHeader(i,headers[i]+"")}}}ss.addEvent(xhr.upload,"progress",function(event){if(event.lengthComputable){var pct=Math.round((event.loaded/event.total)*100);opts.onProgress.call(self,pct);if(pctBox){pctBox.innerHTML=pct+"%"}if(progBar){progBar.style.width=pct+"%"}}});if(opts.multipart===true){var formData=new FormData();for(var prop in params){if(params.hasOwnProperty(prop)){formData.append(prop,params[prop])}}formData.append(opts.name,fileObj.file);this.log("Commencing upload using multipart form");xhr.send(formData)}else{this.log("Commencing upload using binary stream");xhr.send(fileObj.file)}this.removeCurrent(fileObj.id)},_initUpload:function(fileObj){var params={},headers={},url;if(false===this._opts.startXHR.call(this,fileObj.name,fileObj.size,fileObj.btn)){if(this._disabled){this.enable(true)}this._active--;return}params[this._opts.name]=fileObj.name;headers["X-Requested-With"]="XMLHttpRequest";headers["X-File-Name"]=!this._opts.encodeCustomHeaders?fileObj.name:encodeURIComponent(fileObj.name);if(this._opts.responseType.toLowerCase()=="json"){headers.Accept="application/json, text/javascript, */*; q=0.01"}if(!this._opts.multipart){headers["Content-Type"]="application/octet-stream"}ss.extendObj(params,this._opts.data);url=this._opts.noParams===true?this._opts.url:this._opts.url+((this._opts.url.indexOf("?")>-1)?"&":"?")+ss.obj2string(params);this._uploadXhr(fileObj,url,params,headers,this._sizeBox,this._progBar,this._progBox,this._pctBox,this._abortBtn,this._removeAbort);this._sizeBox=this._progBar=this._progBox=this._pctBox=this._abortBtn=this._removeAbort=null}};(function(){ss.extendObj(ss.SimpleUpload.prototype,{_createInput:function(){var self=this,div=document.createElement("div");this._input=document.createElement("input");this._input.type="file";this._input.name=this._opts.name;if(XhrOk&&!isSafari&&this._opts.multiple){this._input.multiple=true}if("accept" in this._input&&this._opts.accept!==""){this._input.accept=this._opts.accept}ss.addStyles(div,{display:"block",position:"absolute",overflow:"hidden",margin:0,padding:0,opacity:0,direction:"ltr",zIndex:2147483582});ss.addStyles(this._input,{position:"absolute",right:0,margin:0,padding:0,fontSize:"480px",fontFamily:"sans-serif",cursor:"pointer",height:"100%"});if(div.style.opacity!=="0"){div.style.filter="alpha(opacity=0)"}this._input.turnOff=ss.addEvent(this._input,"change",function(){if(!self._input||self._input.value===""){return}if(false===self._addFiles(XhrOk?self._input.files:self._input)){return}ss.removeClass(self._overBtn,self._opts.hoverClass);ss.removeClass(self._overBtn,self._opts.focusClass);self._killInput();self._createInput();if(self._opts.autoSubmit){self.submit()}});if(self._opts.hoverClass!==""){div.mouseOverOff=ss.addEvent(div,"mouseover",function(){ss.addClass(self._overBtn,self._opts.hoverClass)})}div.mouseOutOff=ss.addEvent(div,"mouseout",function(){self._input.parentNode.style.visibility="hidden";if(self._opts.hoverClass!==""){ss.removeClass(self._overBtn,self._opts.hoverClass);ss.removeClass(self._overBtn,self._opts.focusClass)}});if(self._opts.focusClass!==""){this._input.focusOff=ss.addEvent(this._input,"focus",function(){ss.addClass(self._overBtn,self._opts.focusClass)});this._input.blurOff=ss.addEvent(this._input,"blur",function(){ss.removeClass(self._overBtn,self._opts.focusClass)})}document.body.appendChild(div);div.appendChild(this._input);div=null},rerouteClicks:function(elem){var self=this;elem.off=ss.addEvent(elem,"mouseover",function(){if(self._disabled){return}if(!self._input){self._createInput()}self._overBtn=elem;ss.copyLayout(elem,self._input.parentNode);self._input.parentNode.style.visibility="visible"});return elem},_last:function(sizeBox,progBox,pctBox,abortBtn,removeAbort){if(sizeBox){sizeBox.innerHTML=""}if(pctBox){pctBox.innerHTML=""}if(abortBtn&&removeAbort){ss.remove(abortBtn)}if(progBox){ss.remove(progBox)}this._active--;sizeBox=progBox=pctBox=abortBtn=removeAbort=null;if(this._disabled){this.enable(true)}if(this._destroy&&this._queue.length===0&&this._active.length===0){for(var prop in this){if(this.hasOwnProperty(prop)){delete this[prop]}}}else{this._cycleQueue()}},_errorFinish:function(fileObj,status,statusText,response,errorType,progBox,sizeBox,pctBox,abortBtn,removeAbort){this.log("Upload failed: "+status+" "+statusText);this._opts.onError.call(this,fileObj.name,errorType,status,statusText,response,fileObj.btn,fileObj.size,fileObj.layer);this._last(sizeBox,progBox,pctBox,abortBtn,removeAbort);fileObj=status=statusText=response=errorType=sizeBox=progBox=pctBox=abortBtn=removeAbort=null},_finish:function(fileObj,status,statusText,response,sizeBox,progBox,pctBox,abortBtn,removeAbort){this.log("Server response: "+response);if(this._opts.responseType.toLowerCase()=="json"){response=ss.parseJSON(response);if(response===false){this._errorFinish(fileObj,status,statusText,false,"parseerror",progBox,sizeBox,abortBtn,removeAbort);return}}this._opts.onComplete.call(this,fileObj.name,response,fileObj.btn,fileObj.size,fileObj.layer);this._last(sizeBox,progBox,pctBox,abortBtn,removeAbort);fileObj=status=statusText=response=sizeBox=progBox=pctBox=abortBtn=removeAbort=null},_checkFile:function(fileObj){var extOk=false,i=this._opts.allowedExtensions.length;if(i>0){while(i--){if(this._opts.allowedExtensions[i].toLowerCase()==fileObj.ext.toLowerCase()){extOk=true;break}}if(!extOk){this.removeCurrent(fileObj.id);this.log("File extension not permitted");this._opts.onExtError.call(this,fileObj.name,fileObj.ext);return false}}if(fileObj.size&&this._opts.maxSize!==false&&fileObj.size>this._opts.maxSize){this.removeCurrent(fileObj.id);this.log(fileObj.name+" exceeds "+this._opts.maxSize+"K limit");this._opts.onSizeError.call(this,fileObj.name,fileObj.size);return false}fileObj=null;return true},submit:function(){if(this._disabled||this._active>=this._opts.maxUploads||this._queue.length<1){return}if(!this._checkFile(this._queue[0])){return}if(false===this._opts.onSubmit.call(this,this._queue[0].name,this._queue[0].ext,this._queue[0].btn,this._queue[0].size)){return}this._active++;if(this._opts.multiple===false||this._opts.queue===false&&this._active>=this._opts.maxUploads){this.disable(true)}this._initUpload(this._queue[0])}});if(XhrOk){ss.extendObj(ss.SimpleUpload.prototype,ss.XhrUpload)}else{ss.extendObj(ss.SimpleUpload.prototype,ss.IframeUpload)}}());ss.extendObj(ss.SimpleUpload.prototype,{_dragFileCheck:function(e){if(e.dataTransfer.types){for(var i=0;i<e.dataTransfer.types.length;i++){if(e.dataTransfer.types[i]=="Files"){return true}}}return false},addDropZone:function(elem){var self=this;ss.addStyles(elem,{zIndex:2147483583});elem.ondragenter=function(e){if(!self._dragFileCheck(e)){return false}ss.addClass(this,self._opts.dragClass);return false};elem.ondragover=function(){return false};elem.ondragend=function(){ss.removeClass(this,self._opts.dragClass);return false};elem.ondragleave=function(){ss.removeClass(this,self._opts.dragClass);return false};elem.ondrop=function(e){e.preventDefault();ss.removeClass(this,self._opts.dragClass);if(!self._dragFileCheck(e)){return false}self._addFiles(e.dataTransfer.files);self._cycleQueue()}}});return ss}));